name: Calc App CD Pipeline

on:
  # Trigger 1: Run automatically after the CI pipeline finishes successfully
  workflow_run:
    workflows: ["Calc App CI Pipeline"]
    types:
      - completed
  # Trigger 2: Allow manual execution from GitHub UI
  workflow_dispatch:
   inputs:
      logLevel:
        description: 'Log Level'
        required: true
        default: 'warning'
        type: choice
        options:
        - info
        - warning
        - debug

permissions:
  id-token: write   # Required for AWS OIDC authentication
  contents: read    # Required to checkout code
  actions: read     # Required to download artifacts from the CI run

jobs:
  deploy:
    # Only run if the CI pipeline was successful (or if triggered manually)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout Code
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Download Image URI Artifacts (Source: Slide 15)
      # This pulls the text files containing the specific ECR image tags from the CI pipeline
      - name: Download Image URI Artifacts
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        with:
          name: image-uris
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # 3. Determine Image URIs & Set Terraform Variables (Source: Slide 15)
      # Reads the text files and injects them as TF_VARs for Terraform to use
      - name: Determine Image URIs
        if: ${{ github.event_name == 'workflow_run' }}
        run: |
          IMAGE_URI_BE=$(cat image_uri_be.txt)
          IMAGE_URI_FE=$(cat image_uri_fe.txt)
          echo "TF_VAR_container_image_be=${IMAGE_URI_BE}" >> ${GITHUB_ENV}
          echo "TF_VAR_container_image_fe=${IMAGE_URI_FE}" >> ${GITHUB_ENV}

      # 4. Configure AWS Credentials (OIDC)
      # Required for Terraform to access the S3 Backend and ECR
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Use the Role ARN provided in your previous context
          role-to-assume: arn:aws:iam::975049962487:role/cas3135-2020134032-gha-role 
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: gha-terraform

      - name: Verify caller identity
        run: aws sts get-caller-identity

      # 5. Set up Terraform (Source: Slide 16)
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # 6. Setup Kubeconfig (Source: Slide 16)
      # Decodes the base64 secret into a file so the Terraform Kubernetes Provider can talk to your remote cluster
      - name: Setup Kubeconfig
        env:
          KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_BASE64 }}
        run: |
          echo "${KUBECONFIG_BASE64}" | base64 --decode > /tmp/kubeconfig
          echo "TF_VAR_kubernetes_config_path=/tmp/kubeconfig" >> ${GITHUB_ENV}

      # 7. Setup Environment Variables for URI References (Source: Slide 16)
      # Maps your GitHub Repository Variables to Terraform Variables
      - name: Setup Environment Variables for URI References
        run: |
          echo "TF_VAR_backend_url=${{ vars.BACKEND_URL }}" >> ${GITHUB_ENV}
          echo "TF_VAR_frontend_url=${{ vars.FRONTEND_URL }}" >> ${GITHUB_ENV}

      # 8. Terraform Init (Source: Slide 17)
      - name: Terraform Init
        run: |
          cd terraform && terraform init

      # 9. Terraform Apply (Source: Slide 17)
      # Applies the configuration to the remote cluster
      - name: Terraform Apply
        run: |
          cd terraform && terraform apply -auto-approve